---
title: 'The Workflow Lifecycle'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- What happens if we re-run a workflow?
- How does `targets` know what steps to re-run?
- How can I override default settings?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Explain how `targets` helps increase efficiency
- Be able to inspect a workflow to see what parts are outdated
- Be able to run only a specific part of the workflow

::::::::::::::::::::::::::::::::::::::::::::::::

```{r}
#| label: setup
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
library(targets)
library(visNetwork)
source(here::here("episodes/files/functions.R"))
```

## Re-running the workflow

One of the features of `targets` is that it maximizes efficiency by only running the parts of the workflow that need to be run.

This is easiest to understand by trying it yourself. Let's try running the workflow again:

```{r}
#| label: targets-run-show
#| eval: FALSE
tar_make()
```

```{r}
#| label: targets-run-hide
#| echo: FALSE
# Each tar_script is fresh, so need to run once to catch up to learners
tar_dir({
  write_example_plan(2)
  tar_make(reporter = "silent")
  tar_make()
})
```

Remember how the first time we ran the pipeline, `targets` printed out a list of each target as it was being built?

This time, it tells us it is skipping those targets; they have already been built, so there's no need to run that code again.

Remember, the fastest code is the code you don't have to run!

## Re-running the workflow after modification

What happens when we change one part of the workflow then run it again?

Let's modify the workflow to calculate the **sum** of the columns instead of the mean.

Edit `_targets.R` so that the `summ()` function looks like this:

```{r}
#| label: new-func
#| eval: FALSE
summ <- function(dataset) {
  colSums(dataset)
}
```

Then run it again.

```{r}
#| label: targets-run-show-2
#| eval: FALSE
tar_make()
```

```{r}
#| label: targets-run-hide-2
#| echo: FALSE
tar_dir({
  # Original workflow
  write_example_plan(2)
  # Run it silently
  tar_make(reporter = "silent")
  # New workflow
  write_example_plan(3)
  # Run it again
  tar_make()
})
```

What happened?

This time, it skipped `my_data` and only ran `my_summary`.

Of course, since our example workflow is so short we don't even notice the amount of time saved.
But imagine using this in a series of computationally intensive analysis steps.
The ability to automatically skip steps results in a massive increase in efficiency.

## Visualizing the workflow

Typically, you will be making edits to various places in your code, adding new targets, and running the workflow periodically.
It is good to be able to visualize the state of the workflow.

This can be done with `tar_visnetwork()`

```{r}
#| label: targets-run-show-3
#| eval: FALSE
tar_visnetwork()
```

```{r}
#| label: targets-run-hide-3
#| echo: FALSE
tar_dir({
  # New workflow
  write_example_plan(3)
  # Run it
  tar_make(reporter = "silent")
  # Run it again
  tar_make(reporter = "silent")
  tar_visnetwork()
})
```

Here, we see that all of the targets are dark green, indicating that they are up-to-date and would be skipped if we were to run the workflow again.

::::::::::::::::::::::::::::::::::::: challenge

## Challenge 1: What else can the visualization tell us?

Modify the workflow in `_targets.R`, then run `tar_visnetwork()` again **without** running `tar_make()`.
What color indicates that a target is out of date?

:::::::::::::::::::::::::::::::::: solution

Light blue indicates the target is out of date.

Depending on how you modified the code, any or all of the targets may now be blue.

::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: caution

When a target is out of date, that does not mean it will absolutely be built during the next run.

:::::::::::::::::::::::::::::::::::::::::::::::

## Other ways to check workflow status

The visualization is very useful, but sometimes you may be working on a server that doesn't provide graphical output, or you just want a quick textual summary of the workflow.
There are some other useful functions that can do that.

`tar_outdated()` lists only the **outdated** targets; that is, targets that will be built during the next workflow run.
If everything is up to date, it will return a zero-length character vector (`character(0)`).

`tar_progress()` shows the current status of the workflow as a dataframe.
You may find it helpful to further manipulate the dataframe to obtain useful summaries of the workflow, for example using `dplyr` (such data manipulation is beyond the scope of this lesson but the instructor may demonstrate its use).

```{r}
#| label: targets-outdated-show
#| eval: FALSE
tar_outdated()
```

```{r}
#| label: targets-outdated-hide
#| echo: FALSE
tar_dir({
  # New workflow
  write_example_plan(3)
  # Run it
  tar_make(reporter = "silent")
  # Run it again
  tar_make(reporter = "silent")
  tar_outdated()
})
```

```{r}
#| label: targets-progress-show
#| eval: FALSE
tar_progress()
```

```{r}
#| label: targets-progress-hide
#| echo: FALSE
tar_dir({
  # New workflow
  write_example_plan(3)
  # Run it
  tar_make(reporter = "silent")
  # Run it again
  tar_make(reporter = "silent")
  tar_progress()
})
```

::::::::::::::::::::::::::::::::::::: callout 

You may encounter an error message `The package "visNetwork" is required.`

In this case, install it first with `install.packages("visNetwork")`.

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: keypoints 

- `targets` only runs the steps that have been affected by a change to the code
- `tar_visnetwork()` shows the current state of the workflow as a network
- `tar_progress()` shows the current state of the workflow as a data frame
- `tar_outdated()` lists outdated targets that will be built in the next `tar_make()`

::::::::::::::::::::::::::::::::::::::::::::::::
